{% extends 'client_portal/base.html' %}
{% load static %}

{% block title %}Discover Local Chefs - Teka{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="bg-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-3">Authentic Home-Cooked Meals</h1>
                <p class="lead mb-4">Discover passionate local chefs creating unique, homemade dishes in your neighborhood. Support your community while enjoying authentic flavors.</p>
                <div class="d-flex gap-3">
                    <button class="btn btn-light btn-lg" onclick="findMyLocation()">
                        <i class="bi bi-geo-alt me-2"></i>Find Chefs Near Me
                    </button>
                    <a href="{% url 'client_portal:chef_list' %}" class="btn btn-outline-light btn-lg">Browse All Chefs</a>
                </div>
            </div>
            <div class="col-lg-6">
                <img src="https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Home cooking" class="img-fluid rounded shadow">
            </div>
        </div>
    </div>
</section>

<!-- Location Search -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="input-group input-group-lg">
                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                    <input type="text" id="location-search" class="form-control" placeholder="Enter your address or postal code">
                    <button class="btn btn-primary" type="button" onclick="searchLocation()">
                        <i class="bi bi-search me-1"></i>Search Chefs
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Featured Chefs -->
<section class="py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <h2 class="text-center mb-3">Featured Chefs in Your Area</h2>
                <p class="text-center text-muted">Discover talented home chefs creating amazing dishes near you</p>
            </div>
        </div>
        
        <div id="featured-chefs" class="row">
            <!-- Featured chefs will be loaded here -->
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading chefs...</span>
                </div>
                <p class="mt-3 text-muted">Finding amazing chefs near you...</p>
            </div>
        </div>
    </div>
</section>

<!-- How It Works -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row mb-5">
            <div class="col text-center">
                <h2>How Teka Works</h2>
                <p class="text-muted">Three simple steps to enjoying authentic home-cooked meals</p>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4 text-center mb-4">
                <div class="feature-icon bg-primary text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                    <i class="bi bi-search fs-3"></i>
                </div>
                <h4>Discover</h4>
                <p class="text-muted">Browse local chefs and their unique menus. Each chef has their own story and specialty dishes.</p>
            </div>
            <div class="col-lg-4 text-center mb-4">
                <div class="feature-icon bg-primary text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                    <i class="bi bi-cart-check fs-3"></i>
                </div>
                <h4>Order</h4>
                <p class="text-muted">Choose your favorite dishes and place your order. Secure payment and real-time order tracking.</p>
            </div>
            <div class="col-lg-4 text-center mb-4">
                <div class="feature-icon bg-primary text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                    <i class="bi bi-emoji-smile fs-3"></i>
                </div>
                <h4>Enjoy</h4>
                <p class="text-muted">Receive your freshly prepared meal and enjoy authentic flavors made with love.</p>
            </div>
        </div>
    </div>
</section>

<!-- CTA Section -->
<section class="py-5 bg-primary text-white">
    <div class="container text-center">
        <h3 class="mb-3">Ready to taste something amazing?</h3>
        <p class="lead mb-4">Join thousands of food lovers discovering authentic meals from passionate local chefs.</p>
        <a href="{% url 'client_portal:register' %}" class="btn btn-light btn-lg me-3">Get Started</a>
        <a href="{% url 'client_portal:chef_list' %}" class="btn btn-outline-light btn-lg">Browse Chefs</a>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let userLocation = null;

// Get user's current location
function findMyLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                loadNearbyChefs(userLocation.lat, userLocation.lng);
            },
            function(error) {
                console.error('Error getting location:', error);
                alert('Could not get your location. Please enter your address manually.');
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

// Search by entered location
function searchLocation() {
    const locationInput = document.getElementById('location-search');
    const address = locationInput.value.trim();
    
    if (!address) {
        alert('Please enter an address or postal code.');
        return;
    }
    
    // In a real implementation, you would geocode the address
    // For now, we'll use a default location
    loadNearbyChefs(40.7128, -74.0060, address); // NYC coordinates as example
}

// Load chefs near specified coordinates
function loadNearbyChefs(lat, lng, searchAddress = null) {
    const query = `
        query GetNearbyChefs($lat: Float!, $lng: Float!, $radius: Int) {
            chefsNearMe(lat: $lat, long: $lng, radius: $radius) {
                id
                user {
                    firstName
                    lastName
                    username
                }
                bio
                profilePicture
                averageRating
                totalReviews
                isAvailable
                distanceKm
                menuItems {
                    id
                    name
                    category
                    price
                }
            }
        }
    `;
    
    fetch('/graphql/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({
            query: query,
            variables: { lat: lat, lng: lng, radius: 15 }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.errors) {
            console.error('GraphQL errors:', data.errors);
            return;
        }
        displayChefs(data.data.chefsNearMe);
    })
    .catch(error => {
        console.error('Error loading chefs:', error);
        displayNoChefs();
    });
}

// Display chefs in the featured section
function displayChefs(chefs) {
    const container = document.getElementById('featured-chefs');
    
    if (!chefs || chefs.length === 0) {
        displayNoChefs();
        return;
    }
    
    container.innerHTML = chefs.slice(0, 6).map(chef => {
        const chefName = chef.user.firstName && chef.user.lastName 
            ? `${chef.user.firstName} ${chef.user.lastName}`
            : chef.user.username;
        
        const cuisines = [...new Set(chef.menuItems.map(item => item.category))].slice(0, 3);
        
        return `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 chef-card" onclick="window.location.href='/chef/${chef.id}/'">
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        ${chef.profilePicture 
                            ? `<img src="${chef.profilePicture}" alt="${chefName}" class="img-fluid rounded">`
                            : `<i class="bi bi-person-circle fs-1 text-muted"></i>`
                        }
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${chefName}</h5>
                        <p class="card-text text-muted small">${chef.bio.substring(0, 100)}...</p>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                ${chef.averageRating > 0 
                                    ? `<span class="text-warning">${'★'.repeat(Math.floor(chef.averageRating))}${'☆'.repeat(5-Math.floor(chef.averageRating))}</span>
                                       <small class="text-muted">(${chef.totalReviews})</small>`
                                    : '<small class="text-muted">New chef</small>'
                                }
                            </div>
                            ${chef.distanceKm ? `<small class="text-muted">${chef.distanceKm} km</small>` : ''}
                        </div>
                        
                        <div class="mb-3">
                            ${cuisines.map(cuisine => 
                                `<span class="badge bg-secondary me-1">${cuisine.replace('_', ' ')}</span>`
                            ).join('')}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge ${chef.isAvailable ? 'bg-success' : 'bg-danger'}">
                                ${chef.isAvailable ? 'Available' : 'Offline'}
                            </span>
                            <small class="text-muted">${chef.menuItems.length} dishes</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Display message when no chefs are found
function displayNoChefs() {
    const container = document.getElementById('featured-chefs');
    container.innerHTML = `
        <div class="col-12 text-center">
            <i class="bi bi-geo-alt fs-1 text-muted mb-3"></i>
            <h4>No chefs found in your area</h4>
            <p class="text-muted">Try expanding your search radius or check back later as we're always adding new chefs!</p>
            <a href="{% url 'client_portal:chef_list' %}" class="btn btn-primary">View All Chefs</a>
        </div>
    `;
}

// Auto-load chefs on page load (try to get location)
document.addEventListener('DOMContentLoaded', function() {
    // Try to get user location automatically, but don't prompt immediately
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                loadNearbyChefs(userLocation.lat, userLocation.lng);
            },
            function(error) {
                // If location access is denied, load some default featured chefs
                console.log('Location access denied, loading default chefs');
                loadNearbyChefs(40.7128, -74.0060); // Default to NYC
            },
            { timeout: 5000, enableHighAccuracy: false }
        );
    } else {
        loadNearbyChefs(40.7128, -74.0060); // Default to NYC
    }
});

// Add hover effects to chef cards
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .chef-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .chef-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}