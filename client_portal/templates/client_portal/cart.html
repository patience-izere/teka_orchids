{% extends 'client_portal/base.html' %}
{% load static %}

{% block title %}Shopping Cart - Teka{% endblock %}

{% block extra_css %}
<style>
    .cart-container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 40px;
        border-radius: 15px;
        text-align: center;
    }
    
    .cart-content {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .cart-item {
        display: flex;
        align-items: center;
        padding: 25px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
    }
    
    .cart-item:hover {
        background-color: #f8f9fa;
    }
    
    .cart-item:last-child {
        border-bottom: none;
    }
    
    .item-image {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        object-fit: cover;
        margin-right: 20px;
    }
    
    .item-details {
        flex: 1;
        margin-right: 20px;
    }
    
    .item-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .chef-name {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    .item-price {
        color: #007bff;
        font-weight: 600;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        margin-right: 20px;
    }
    
    .quantity-btn {
        width: 35px;
        height: 35px;
        border: 2px solid #007bff;
        background: white;
        color: #007bff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
        background: #007bff;
        color: white;
    }
    
    .quantity-display {
        margin: 0 15px;
        font-weight: 600;
        min-width: 30px;
        text-align: center;
    }
    
    .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .remove-btn:hover {
        background: #c82333;
    }
    
    .cart-summary {
        background: #f8f9fa;
        padding: 30px;
        margin-top: 30px;
        border-radius: 15px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 8px 0;
    }
    
    .summary-row.total {
        border-top: 2px solid #dee2e6;
        padding-top: 20px;
        margin-top: 20px;
        font-size: 1.2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .checkout-section {
        text-align: center;
        padding: 30px 0;
    }
    
    .checkout-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.1em;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .checkout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .checkout-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .empty-cart {
        text-align: center;
        padding: 80px 40px;
        color: #666;
    }
    
    .empty-icon {
        font-size: 5rem;
        color: #ddd;
        margin-bottom: 30px;
    }
    
    .continue-shopping {
        background: #007bff;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        display: inline-block;
        margin-top: 20px;
        transition: all 0.3s ease;
    }
    
    .continue-shopping:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
    }
    
    .delivery-info {
        background: #e7f3ff;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #007bff;
        margin: 20px 0;
    }
    
    .estimated-time {
        font-size: 0.9em;
        color: #666;
        margin-top: 10px;
    }
    
    .promo-code {
        margin: 20px 0;
    }
    
    .promo-input {
        display: flex;
        gap: 10px;
    }
    
    .promo-input input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95em;
    }
    
    .promo-input button {
        padding: 12px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .cart-item {
            flex-direction: column;
            text-align: center;
        }
        
        .item-image {
            margin: 0 0 15px 0;
        }
        
        .item-details {
            margin: 0 0 15px 0;
        }
        
        .quantity-controls {
            margin: 0 0 15px 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container cart-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="bi bi-cart3 me-3"></i>Shopping Cart</h1>
        <p class="lead mb-0">Review your delicious selections</p>
    </div>
    
    <!-- Cart Content -->
    <div class="cart-content">
        <div id="cart-items-container">
            <!-- Cart items will be populated by JavaScript -->
        </div>
        
        <!-- Empty Cart Message -->
        <div id="empty-cart" class="empty-cart" style="display: none;">
            <div class="empty-icon">
                <i class="bi bi-cart-x"></i>
            </div>
            <h3>Your cart is empty</h3>
            <p>Add some delicious items from our amazing chefs!</p>
            <a href="{% url 'client_portal:chef_list' %}" class="continue-shopping">
                <i class="bi bi-search me-2"></i>Discover Chefs
            </a>
        </div>
    </div>
    
    <!-- Cart Summary -->
    <div id="cart-summary" class="cart-summary" style="display: none;">
        <h4><i class="bi bi-receipt me-2"></i>Order Summary</h4>
        
        <div class="delivery-info">
            <h6><i class="bi bi-truck me-2"></i>Delivery Information</h6>
            <p class="mb-2">
                <strong>Delivery to:</strong> <span id="delivery-address">Your current location</span>
            </p>
            <div class="estimated-time">
                <i class="bi bi-clock me-1"></i>
                Estimated delivery: 45-60 minutes
            </div>
        </div>
        
        <!-- Promo Code Section -->
        <div class="promo-code">
            <h6>Promo Code</h6>
            <div class="promo-input">
                <input type="text" id="promo-code-input" placeholder="Enter promo code">
                <button onclick="applyPromoCode()">Apply</button>
            </div>
        </div>
        
        <!-- Price Breakdown -->
        <div class="summary-row">
            <span>Subtotal:</span>
            <span id="subtotal">$0.00</span>
        </div>
        <div class="summary-row">
            <span>Delivery Fee:</span>
            <span id="delivery-fee">$5.00</span>
        </div>
        <div class="summary-row">
            <span>Platform Fee:</span>
            <span id="platform-fee">$0.00</span>
        </div>
        <div class="summary-row" id="discount-row" style="display: none;">
            <span>Discount:</span>
            <span id="discount" class="text-success">-$0.00</span>
        </div>
        <div class="summary-row total">
            <span>Total:</span>
            <span id="total">$0.00</span>
        </div>
        
        <!-- Checkout Button -->
        <div class="checkout-section">
            <button id="checkout-btn" class="checkout-btn" onclick="proceedToCheckout()">
                <i class="bi bi-credit-card me-2"></i>
                Proceed to Checkout
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressModalLabel">
                    <i class="bi bi-geo-alt me-2"></i>Delivery Address
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <div class="mb-3">
                        <label for="full-address" class="form-label">Full Address</label>
                        <textarea class="form-control" id="full-address" name="address" rows="3" 
                                  placeholder="Enter your complete delivery address..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="delivery-instructions" class="form-label">Delivery Instructions (Optional)</label>
                        <textarea class="form-control" id="delivery-instructions" name="instructions" rows="2" 
                                  placeholder="Any special delivery instructions..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAddress()">
                    <i class="bi bi-check-lg me-2"></i>Save Address
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cart Management
let cart = JSON.parse(localStorage.getItem('tekaCart')) || [];
let deliveryFee = 5.00;
let platformFeeRate = 0.10; // 10%
let discount = 0;

// Initialize cart on page load
document.addEventListener('DOMContentLoaded', function() {
    renderCart();
    updateCartSummary();
});

function renderCart() {
    const container = document.getElementById('cart-items-container');
    const emptyCart = document.getElementById('empty-cart');
    const cartSummary = document.getElementById('cart-summary');
    
    if (cart.length === 0) {
        container.innerHTML = '';
        emptyCart.style.display = 'block';
        cartSummary.style.display = 'none';
        return;
    }
    
    emptyCart.style.display = 'none';
    cartSummary.style.display = 'block';
    
    let html = '';
    cart.forEach((item, index) => {
        html += `
        <div class="cart-item" data-index="${index}">
            <img src="${item.image || 'https://via.placeholder.com/80x80/28a745/white?text=ðŸ½ï¸'}" 
                 alt="${item.name}" class="item-image">
            
            <div class="item-details">
                <div class="item-name">${item.name}</div>
                <div class="chef-name">
                    <i class="bi bi-person me-1"></i>by ${item.chef_name}
                </div>
                <div class="item-price">$${parseFloat(item.price).toFixed(2)} each</div>
                ${item.special_instructions ? `<small class="text-muted">Note: ${item.special_instructions}</small>` : ''}
            </div>
            
            <div class="quantity-controls">
                <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">
                    <i class="bi bi-dash"></i>
                </button>
                <div class="quantity-display">${item.quantity}</div>
                <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">
                    <i class="bi bi-plus"></i>
                </button>
            </div>
            
            <div class="item-total me-3">
                <strong>$${(parseFloat(item.price) * item.quantity).toFixed(2)}</strong>
            </div>
            
            <button class="remove-btn" onclick="removeFromCart(${index})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateQuantity(index, change) {
    if (index >= 0 && index < cart.length) {
        cart[index].quantity += change;
        
        if (cart[index].quantity <= 0) {
            cart.splice(index, 1);
        }
        
        saveCart();
        renderCart();
        updateCartSummary();
        updateCartCount();
    }
}

function removeFromCart(index) {
    if (confirm('Remove this item from your cart?')) {
        cart.splice(index, 1);
        saveCart();
        renderCart();
        updateCartSummary();
        updateCartCount();
    }
}

function updateCartSummary() {
    if (cart.length === 0) return;
    
    const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
    const platformFee = subtotal * platformFeeRate;
    const total = subtotal + deliveryFee + platformFee - discount;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('platform-fee').textContent = `$${platformFee.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    
    // Show/hide discount row
    const discountRow = document.getElementById('discount-row');
    if (discount > 0) {
        discountRow.style.display = 'flex';
        document.getElementById('discount').textContent = `-$${discount.toFixed(2)}`;
    } else {
        discountRow.style.display = 'none';
    }
}

function saveCart() {
    localStorage.setItem('tekaCart', JSON.stringify(cart));
}

function updateCartCount() {
    const count = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
        cartCountElement.textContent = count;
    }
}

function applyPromoCode() {
    const promoCode = document.getElementById('promo-code-input').value.trim();
    
    if (!promoCode) {
        alert('Please enter a promo code');
        return;
    }
    
    // Mock promo codes for demo
    const promoCodes = {
        'WELCOME10': 0.10,  // 10% discount
        'FIRST15': 0.15,    // 15% discount
        'SAVE5': 5.00       // $5 off
    };
    
    if (promoCodes[promoCode.toUpperCase()]) {
        const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
        const discountValue = promoCodes[promoCode.toUpperCase()];
        
        if (discountValue < 1) {
            // Percentage discount
            discount = subtotal * discountValue;
        } else {
            // Fixed amount discount
            discount = Math.min(discountValue, subtotal);
        }
        
        updateCartSummary();
        alert(`Promo code applied! You saved $${discount.toFixed(2)}`);
        document.getElementById('promo-code-input').value = '';
    } else {
        alert('Invalid promo code. Please try again.');
    }
}

async function proceedToCheckout() {
    if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
    }
    
    // Check if user is logged in
    {% if not user.is_authenticated %}
    if (confirm('You need to log in to proceed. Would you like to log in now?')) {
        window.location.href = '{% url "client_portal:login" %}?next=' + encodeURIComponent(window.location.pathname);
        return;
    } else {
        return;
    }
    {% endif %}
    
    // Check if delivery address is set
    const deliveryAddress = localStorage.getItem('deliveryAddress');
    if (!deliveryAddress) {
        // Show address modal
        new bootstrap.Modal(document.getElementById('addressModal')).show();
        return;
    }
    
    // Show loading
    document.getElementById('loading-overlay').style.display = 'flex';
    
    try {
        // First validate cart items
        const validationResponse = await fetch('{% url "client_portal:validate_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ items: cart })
        });
        
        const validationData = await validationResponse.json();
        
        if (!validationData.success) {
            throw new Error('Cart validation failed');
        }
        
        if (!validationData.all_valid) {
            // Handle validation errors
            let errorMessage = 'Some items in your cart have issues:\n';
            validationData.items.forEach(item => {
                if (!item.valid) {
                    errorMessage += `- ${item.error}\n`;
                }
            });
            
            if (confirm(errorMessage + '\nWould you like to remove invalid items and continue?')) {
                // Remove invalid items from cart
                cart = cart.filter(cartItem => {
                    const validation = validationData.items.find(v => v.id === cartItem.id);
                    return validation && validation.valid;
                });
                
                // Update prices for items with price changes
                validationData.items.forEach(item => {
                    if (item.valid && item.new_price) {
                        const cartItem = cart.find(c => c.id === item.id);
                        if (cartItem) {
                            cartItem.price = item.new_price;
                        }
                    }
                });
                
                saveCart();
                renderCart();
            } else {
                return;
            }
        }
        
        // Create order via AJAX
        const orderData = {
            items: cart,
            delivery_address: deliveryAddress,
            delivery_instructions: localStorage.getItem('deliveryInstructions') || '',
            promo_discount: discount
        };
        
        const response = await fetch('{% url "client_portal:create_order" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear cart and redirect to checkout
            cart = [];
            saveCart();
            window.location.href = `/client/checkout/${data.order_id}/`;
        } else {
            throw new Error(data.error || 'Failed to create order');
        }
        
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
        console.error('Checkout error:', error);
    } finally {
        document.getElementById('loading-overlay').style.display = 'none';
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function saveAddress() {
    const address = document.getElementById('full-address').value.trim();
    const instructions = document.getElementById('delivery-instructions').value.trim();
    
    if (!address) {
        alert('Please enter a delivery address');
        return;
    }
    
    localStorage.setItem('deliveryAddress', address);
    localStorage.setItem('deliveryInstructions', instructions);
    
    // Update display
    document.getElementById('delivery-address').textContent = address.substring(0, 50) + (address.length > 50 ? '...' : '');
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
    
    // Proceed to checkout
    proceedToCheckout();
}

// Initialize delivery address display
document.addEventListener('DOMContentLoaded', function() {
    const savedAddress = localStorage.getItem('deliveryAddress');
    if (savedAddress) {
        document.getElementById('delivery-address').textContent = savedAddress.substring(0, 50) + (savedAddress.length > 50 ? '...' : '');
    }
});

// Update cart count on page load
document.addEventListener('DOMContentLoaded', updateCartCount);
</script>
{% endblock %}